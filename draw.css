// draw.js - LOGIC QUAY Sá» VÃ’NG QUAY MAY Máº®N VÃ€ KIá»‚M SOÃT RESET

// Danh sÃ¡ch ngÆ°á»i tham gia gá»‘c (Báº N PHáº¢I Cáº¬P NHáº¬T DANH SÃCH NÃ€Y)
const participants = [
    "Nguyá»…n VÄƒn A", 
    "Tráº§n Thá»‹ B", 
    "LÃª VÄƒn C", 
    "Pháº¡m Thá»‹ D", 
    "HoÃ ng VÄƒn E",
    "Pháº¡m VÄƒn F",
    "Nguyá»…n Thá»‹ G",
    "Tráº§n VÄƒn H"
    // THÃŠM Táº¤T Cáº¢ TÃŠN NGÆ¯á»œI THAM GIA VÃ€O ÄÃ‚Y
];

// Danh sÃ¡ch ngÆ°á»i tháº¯ng cuá»™c (sáº½ Ä‘Æ°á»£c táº£i tá»« localStorage)
let winners = []; 
let isSpinning = false;
let slotRollerElement = null;

// --- A. LOGIC LÆ¯U TRá»® VÃ€ RESET ---

/**
 * Táº£i danh sÃ¡ch ngÆ°á»i tháº¯ng cuá»™c tá»« localStorage.
 */
function loadWinners() {
    const savedWinners = localStorage.getItem('galaDrawWinners');
    if (savedWinners) {
        try {
            // Danh sÃ¡ch winners lÆ°u trá»¯ dÆ°á»›i dáº¡ng { name: "...", time: "..." }
            winners = JSON.parse(savedWinners);
        } catch (e) {
            console.error("Lá»—i khi táº£i danh sÃ¡ch ngÆ°á»i tháº¯ng cuá»™c:", e);
            winners = []; 
        }
    } else {
        winners = [];
    }
}

/**
 * LÆ°u danh sÃ¡ch ngÆ°á»i tháº¯ng cuá»™c vÃ o localStorage.
 */
function saveWinners() {
    localStorage.setItem('galaDrawWinners', JSON.stringify(winners));
}

/**
 * Lá»c danh sÃ¡ch tham gia Ä‘á»ƒ loáº¡i bá» nhá»¯ng ngÆ°á»i Ä‘Ã£ tháº¯ng.
 * @returns {Array} Danh sÃ¡ch ngÆ°á»i chÆ¡i Ä‘á»§ Ä‘iá»u kiá»‡n.
 */
function getAvailableParticipants() {
    // Táº¡o Set chá»©a tÃªn ngÆ°á»i Ä‘Ã£ tháº¯ng Ä‘á»ƒ kiá»ƒm tra nhanh hÆ¡n
    const winnerNames = new Set(winners.map(w => w.name)); 
    // Lá»c danh sÃ¡ch gá»‘c (participants)
    return participants.filter(p => !winnerNames.has(p));
}

/**
 * Hiá»ƒn thá»‹ há»™p thoáº¡i há»i ngÆ°á»i dÃ¹ng cÃ³ muá»‘n Reset danh sÃ¡ch Ä‘Ã£ trÃºng thÆ°á»Ÿng khÃ´ng.
 */
function askForReset() {
    loadWinners(); // Táº£i danh sÃ¡ch Ä‘Ã£ tháº¯ng trÆ°á»›c

    if (winners.length > 0) {
        const confirmReset = confirm(
            `ÄÃ£ cÃ³ ${winners.length} ngÆ°á»i trÃºng thÆ°á»Ÿng Ä‘Æ°á»£c lÆ°u trá»¯. Báº¡n cÃ³ muá»‘n Äáº¶T Láº I (RESET) danh sÃ¡ch trÃºng thÆ°á»Ÿng khÃ´ng?`
        );

        if (confirmReset) {
            winners = [];
            localStorage.removeItem('galaDrawWinners');
            alert("Danh sÃ¡ch trÃºng thÆ°á»Ÿng Ä‘Ã£ Ä‘Æ°á»£c Äáº¶T Láº I thÃ nh cÃ´ng!");
        } else {
            alert(`Tiáº¿p tá»¥c quay thÆ°á»Ÿng vá»›i ${getAvailableParticipants().length} ngÆ°á»i chÆ¡i Ä‘á»§ Ä‘iá»u kiá»‡n.`);
        }
    }
}

// --- B. LOGIC QUAY Sá» ---

/**
 * Chá»n ngáº«u nhiÃªn má»™t ngÆ°á»i tá»« danh sÃ¡ch Ä‘á»§ Ä‘iá»u kiá»‡n VÃ€ tráº£ vá» Vá»Š TRÃ (Index) cá»§a ngÆ°á»i tháº¯ng cuá»™c.
 * KHÃ”NG XÃ“A ngÆ°á»i tháº¯ng cuá»™c ngay táº¡i Ä‘Ã¢y.
 */
function selectRandomWinnerWithIndex() {
    const availableParticipants = getAvailableParticipants();
    
    if (availableParticipants.length === 0) {
        return { indexInAvailableList: -1, name: "Háº¾T NGÆ¯á»œI CHÆ I" };
    }

    const randomIndex = Math.floor(Math.random() * availableParticipants.length);
    const winnerName = availableParticipants[randomIndex];

    return { 
        indexInAvailableList: randomIndex, 
        name: winnerName 
    };
}

/**
 * XÃ¢y dá»±ng thanh cuá»™n Slot áº£o báº±ng cÃ¡ch chÃ¨n tÃªn Ä‘á»‡m vÃ  tÃªn ngÆ°á»i chiáº¿n tháº¯ng.
 * @returns {number} Vá»‹ trÃ­ pixel (px) cáº§n cuá»™n Ä‘á»ƒ dá»«ng chÃ­nh xÃ¡c á»Ÿ ngÆ°á»i tháº¯ng cuá»™c.
 */
function buildSlotRoller(availableParticipants, winnerIndex) {
    slotRollerElement.innerHTML = ''; 
    const rollerNames = [...availableParticipants]; // Sao chÃ©p danh sÃ¡ch Ä‘á»§ Ä‘iá»u kiá»‡n

    // 1. ThÃªm 10 tÃªn ngáº«u nhiÃªn ban Ä‘áº§u Ä‘á»ƒ táº¡o Ä‘Ã  cuá»™n
    for (let i = 0; i < 10; i++) {
        const randomIndex = Math.floor(Math.random() * availableParticipants.length);
        rollerNames.push(availableParticipants[randomIndex]);
    }

    // 2. ThÃªm ngÆ°á»i chiáº¿n tháº¯ng vÃ o cuá»‘i danh sÃ¡ch cuá»™n
    const winnerName = availableParticipants[winnerIndex];
    rollerNames.push(winnerName); 

    // 3. ThÃªm 5 tÃªn ngáº«u nhiÃªn ná»¯a sau ngÆ°á»i chiáº¿n tháº¯ng Ä‘á»ƒ lÃ m Ä‘á»‡m dá»«ng
    for (let i = 0; i < 5; i++) {
        const randomIndex = Math.floor(Math.random() * availableParticipants.length);
        rollerNames.push(availableParticipants[randomIndex]);
    }

    // 4. Äá»• tÃªn vÃ o HTML
    rollerNames.forEach(name => {
        const div = document.createElement('div');
        div.className = 'slot-name';
        div.textContent = name;
        slotRollerElement.appendChild(div);
    });

    // 5. TÃ­nh toÃ¡n vá»‹ trÃ­ dá»«ng
    // Tá»•ng sá»‘ tÃªn trÆ°á»›c ngÆ°á»i tháº¯ng cuá»™c: 10 (Ä‘á»‡m) + winnerIndex 
    const totalNamesBeforeWinner = 10 + winnerIndex; 
    // Láº¥y chiá»u cao cá»§a má»™t má»¥c tÃªn (Ä‘áº£m báº£o pháº£i cÃ³ Ã­t nháº¥t 1 má»¥c)
    const itemHeight = slotRollerElement.querySelector('.slot-name').offsetHeight;
    
    return totalNamesBeforeWinner * itemHeight;
}


/**
 * Logic chÃ­nh Ä‘á»ƒ khá»Ÿi Ä‘á»™ng hiá»‡u á»©ng quay sá»‘ vÃ  dá»«ng táº¡i ngÆ°á»i chiáº¿n tháº¯ng.
 */
function toggleSpin(slotDisplayWrapper, spinButton) {
    const availableParticipants = getAvailableParticipants();
    
    if (isSpinning || availableParticipants.length === 0) {
        if (availableParticipants.length === 0) slotRollerElement.innerHTML = '<div class="slot-name">Háº¾T NGÆ¯á»œI CHÆ I</div>';
        return;
    }

    const winnerData = selectRandomWinnerWithIndex();
    
    // 1. CHUáº¨N Bá»Š VÃ€ TÃNH TOÃN
    // Äáº£m báº£o slotRollerElement Ä‘Ã£ Ä‘Æ°á»£c khá»Ÿi táº¡o trÆ°á»›c
    if (!slotRollerElement) slotRollerElement = document.getElementById('slotRoller');
    
    const stopPosition = buildSlotRoller(availableParticipants, winnerData.indexInAvailableList);
    
    // --- Báº®T Äáº¦U QUAY ---
    isSpinning = true;
    spinButton.textContent = "ÄANG QUAY...";
    spinButton.disabled = true;

    // 2. KÃCH HOáº T HIá»†U á»¨NG CUá»˜N CSS (Cuá»™n nhanh)
    slotRollerElement.style.transition = 'none';
    slotRollerElement.style.transform = 'translateY(0)';
    slotRollerElement.style.animation = 'slotRoll 0.1s linear infinite';
    
    // 3. Dá»ªNG QUAY VÃ€ CHá»ŒN Káº¾T QUáº¢ CUá»I CÃ™NG (Sau 1 giÃ¢y cuá»™n nhanh)
    const totalSpinTime = 25000; // Tá»•ng thá»i gian quay: 25 giÃ¢y
    const quickSpinTime = 1000; // Cuá»™n nhanh: 1 giÃ¢y
    const smoothStopDuration = totalSpinTime - quickSpinTime; // Dá»«ng mÆ°á»£t: 24 giÃ¢y

    setTimeout(() => {
        // a. Dá»ªNG HIá»†U á»¨NG CUá»˜N CSS vÃ  Ã¡p dá»¥ng transition dá»«ng mÆ°á»£t
        slotRollerElement.style.animation = 'none'; 
        slotRollerElement.style.transition = `transform ${smoothStopDuration / 1000}s cubic-bezier(0.1, 0.7, 0.9, 1)`; 
        
        // b. Dá»ŠCH CHUYá»‚N Äáº¾N Vá»Š TRÃ Dá»ªNG
        slotRollerElement.style.transform = `translateY(-${stopPosition}px)`; 
        
        // c. LOGIC Káº¾T THÃšC (Sau khi transition dá»«ng láº¡i)
        setTimeout(() => {
            
            // XÃ“A ngÆ°á»i chiáº¿n tháº¯ng khá»i danh sÃ¡ch Ä‘Ã£ tháº¯ng vÃ  lÆ°u láº¡i
            winners.push({ name: winnerData.name, time: new Date().toISOString() }); 
            saveWinners(); 
            
            isSpinning = false;
            spinButton.textContent = "Báº®T Äáº¦U QUAY";
            spinButton.disabled = false;
            
            alert(`ğŸ‰ CHÃšC Má»ªNG: ${winnerData.name} Ä‘Ã£ trÃºng thÆ°á»Ÿng!`);
            
            // ÄÆ°a vá» tráº¡ng thÃ¡i ban Ä‘áº§u sau khi quay xong
            slotRollerElement.innerHTML = `<div class="slot-name">Sáº´N SÃ€NG</div>`;

        }, smoothStopDuration); 

    }, quickSpinTime); 
}

// --- C. HÃ€M KHá»I Táº O CHUNG (Gáº¯n vÃ o DOMContentLoaded cá»§a prizes.js) ---

window.initDrawLogic = function() {
    // 1. Há»I RESET KHI Má» APP (TrÆ°á»›c khi khá»Ÿi táº¡o nÃºt)
    askForReset(); 
    
    // 2. LOGIC NÃšT QUAY
    const slotDisplayWrapper = document.getElementById('slotDisplayWrapper');
    const spinButton = document.getElementById('spinButton');
    slotRollerElement = document.getElementById('slotRoller'); // GÃ¡n element

    if (spinButton) {
        spinButton.onclick = function() {
            toggleSpin(slotDisplayWrapper, spinButton);
        };
    }
};
